"use strict";angular.module("garage",["ngCookies","angular-toArrayFilter"]).directive("moveNext",function(){return{restrict:"A",link:function(e,a){a.on("input",function(e){if(a.val().length==a.attr("maxlength")){console.log("Longueur maximale atteinte");var o=a.attr("id").slice(-1),i=a.attr("data-vehiculeId");console.log(o,i),o="#vehicule_"+parseInt(i,10)+"_numero_chassis"+(parseInt(o,10)+1),console.log(o);var r=angular.element(o);console.log(r),r.length?r[0].focus():console.log("Dernier champ")}else console.log("Longueur maximale pas encore atteinte")})}}}).directive("garageLoader",function(){return{restrict:"E",replace:!0,template:"<h4><i class='fa fa-wrench faa-wrench animated'></i>   <i class='fa fa-car faa-bounce animated'></i><br>Chargement en cours...</h4>"}}).config(["$httpProvider",function(e){e.interceptors.push("LoadingInterceptor")}]),$(function(){$('[data-toggle="tooltip"]').tooltip(),$(".menu-toggle-btn").click(function(e){e.preventDefault(),$("#wrapper").toggleClass("toggled")}),$("#file_tree").fileTree({root:"/Chapelle_PHP/",script:"../dist/php/jqueryFileTree.php",expandSpeed:200,collapseSpeed:200,multiFolder:!1},function(e){var a=e.replace(/Chapelle_PHP\//g,"");alert("Veuillez vous rendre dans la documentation ou sur GitHub (voir footer) pour avoir accès au code de \n "+a),$("#docLink").css({color:"red","font-size":"20px",transition:"0.3s"}).addClass("faa-horizontal animated"),$("#github-icon").addClass("faa-shake animated"),$("#github-icon").attr("style","color:red")}),$("#github-icon").hover(function(){$(this).removeClass("faa-shake animated"),$(this).attr("style","")}),$("#docLink").on({mouseover:function(){$(this).removeClass("faa-horizontal animated")},click:function(){$(this).css({color:"#999","font-size":"inherit",transition:"0s"})}}),$("#homeBanner").on({mouseenter:function(){$("#wrenchIcon, #carIcon").addClass("animated")},mouseleave:function(){$("#wrenchIcon, #carIcon").removeClass("animated")}}),$(".show-reparation-desc").click(function(e){e.preventDefault(),e.stopPropagation();var a=$(this).attr("id").split("-")[2];$("#description-"+a).toggleClass("hide"),$("#icon-"+a).toggleClass("fa-eye fa-eye-slash");var o=$(this).attr("data-original-title"),i="Afficher la description"===o?"Masquer la description":"Afficher la description";$(this).attr("data-original-title",i)});var e=!0;$(".show-infos").click(function(){e?$("#infos-ul").slideToggle("fast",function(){$("#infos").fadeOut(10)}):$("#infos").fadeIn(10,function(){$("#infos-ul").slideToggle("slow")}),e=!e,$(this).find("i").toggleClass("fa-eye-slash fa-eye")});var a=!0;$(".show-reparations").click(function(){$("#reparations-ul")[0]?a?$("#reparations-ul").slideToggle("slow",function(){$("#reparations").fadeOut(10)}):$("#reparations").fadeIn(10,function(){$("#reparations-ul").slideToggle("slow")}):a?$("#alert").slideToggle("slow",function(){$("#reparations").fadeOut(10)}):$("#reparations").fadeIn(10,function(){$("#alert").slideToggle("slow")}),a=!a,$(this).find("i").toggleClass("fa-eye-slash fa-eye")});var o=$("#date").val();$(".datepicker").datepicker({dateFormat:"yy-mm-dd",defaultDate:o}),$(".datepicker").datepicker("option",$.datepicker.regional.fr)}),$("#show-list").click(function(e){e.preventDefault();var a=$("#vehicules-panels");a.hasClass("hide")||a.fadeOut(),$(this).removeClass("btn-default").addClass("btn-primary"),$("#show-panels").removeClass("btn-primary").addClass("btn-default"),$("#vehicules-list").fadeIn()}),$("#show-panels").click(function(e){e.preventDefault(),$("#vehicules-list").fadeOut(),$("#show-list").removeClass("btn-primary").addClass("btn-default"),$(this).removeClass("btn-default").addClass("btn-primary"),$("#vehicules-panels").fadeIn()}),$("#csv-btn").click(function(e){e.preventDefault(),$("#alert-csv").toggleClass("hide")}),$("#csv-btn-2").click(function(){$("#csv-input").click()});var files;$("#csv-input").change(function(e){files=e.target.files;var a=e.target.files[0];console.log(a);var o=a.name+" ("+a.size/1e3+"kb) : "+("text/csv"===a.type?"Fichier valide":"Veuillez choisir un fichier .csv");$("#response").fadeIn(),$("#response-txt").text(o),"text/csv"!==a.type?($("#submit").prop("disabled","true"),$("#response").removeClass("alert-info").removeClass("alert-success").addClass("alert-danger")):($("#response").removeClass("alert-danger").removeClass("alert-info").addClass("alert-success"),$("#submit").prop("disabled","").removeClass("btn-success").addClass("btn-default"))}),$("#csv-form").submit(function(e){e.stopPropagation(),e.preventDefault();var a=new FormData;$.each(files,function(e,o){a.append(e,o)}),console.log("fd"),console.log(a),$.post({url:"index.php?p=vehicules.importCSV",data:a,cache:!1,dataType:"json",processData:!1,contentType:!1,success:function(e){console.log("réussite de la requete ajax"),console.log(e);var a=""!=e.errorRows?parseInt(e.errorRows,10):0,o=""!=e.insertedRows?parseInt(e.insertedRows,10)-1:0,i=a+o,r=""!=e.errorRowNumbers?" lignes ("+e.errorRowNumbers+")":"",n="Total des lignes : "+i+"<br> Lignes insérées : "+o+"<br> Erreurs : "+a+r;$("#response-txt").html(n);var t=$("<a></a>");t.attr("href","index.php?p=vehicules.indexPHP").attr("class","btn btn-sm btn-primary").append('<i class="fa fa-refresh fa-fw"></i> Rafraichir'),$("#submit-csv").hide().after(t)},error:function(e,a,o){console.log(e,a,o)}})}),angular.module("garage").controller("GarageCtrl",["$scope","$rootScope","$cookies","$http",function(e,a,o,i){a.logged=i.get("index.php?p=utilisateurs.isLogged").then(function(e){console.log("reponse isLogged"),console.log(e.data),a.logged=""!=e.data}),e.cookie=o.get("alert"),e.setAlertCookie=function(){var e=new Date;e.setDate(e.getDate()+365),o.put("alert","true",{expires:e})}}]).controller("LoginCtrl",["$scope","$rootScope","$cookies","$http",function(e,a,o,i){var r=o.get("garageLogin");e.remember=!1,r&&(e.remember=!0,e.login=o.get("garageLogin"),i({method:"POST",url:"index.php?p=utilisateurs.getPassword",data:$.param({login:e.login}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(a){console.log("Réponse mot de passe",a),e.mdp=a.data})),e.validerLogin=function(){i({method:"POST",url:"index.php?p=utilisateurs.validateLogin",data:$.param({login:e.login,mdp:e.mdp,remember:e.remember}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(o){e.message=o.data.message,o.data.status&&(a.logged=!0,e.success=!0,window.location.replace("index.php"))},function(a){e.message=a.status})}}]).controller("VehiculesController",["$scope","$rootScope","VehiculesService","ReparationsService",function(e,a,o,i){e.vehiculeToEdit={},e.showSuccessMessage=!1,e.successMessage="",e.orderVehicules="marque",e.reverse=!1,e.vehicules=o.getVehicules().then(function(a){e.vehicules=a}),e.options=o.getOptions().then(function(a){e.options=a}),e.userVehiculeForm={marque:"",plaque:"",numero_chassis:"",modele:"",type:"",id:""},e.switchOrder=function(){"desc"===e.sortOrder&&(e.orderVehicules="-"+e.orderVehicules)},e.edit=function(a){e.vehiculeToEdit=a},e.remove=function(a){console.log(a.id),confirm("*** Voulez-vous vraiment supprimer ce véhicule ? ***")&&(o.deleteVehicule(a.id),e.vehicules.splice(e.vehicules.indexOf(a),1),e.showSuccessMessage=!0,e.successMessage="Véhicule "+a.marque+" "+a.modele+" supprimé avec succès !")},e.$on("reparationDeleted",function(a,o){var i=o[0],r=o[1],n=o[2];console.log("index de la rep : ",i),console.log("index à supprimer : ",r),console.log("vehicules : ",e.vehicules),console.log("vehicule contenant la rep : ",e.vehicules[r]),console.log(angular.element("#modalShowReparation"+n)),e.vehicules[r].reparations.splice(i,1),e.showSuccessMessage=!0,e.successMessage="Réparation #"+n+" supprimée avec succès !"})}]).controller("AddVehiculeController",["$scope","VehiculesService",function(e,a){e.plaquePattern=/^[01]-[a-zA-Z]{3}-[0-9]{3}$/,e.plaquePattern1=/^[a-zA-Z]{3}$/,e.plaquePattern2=/^[0-9]{3}$/,e.validateVehicule=function(){e.vehiculeForm.$dirty&&(e.userVehiculeForm.numero_chassis=e.userVehiculeForm.numero_chassis1+"-"+e.userVehiculeForm.numero_chassis2+"-"+e.userVehiculeForm.numero_chassis3+"-"+e.userVehiculeForm.numero_chassis4,e.userVehiculeForm.plaque=e.userVehiculeForm.plaque1+"-"+e.userVehiculeForm.plaque2.toUpperCase()+"-"+e.userVehiculeForm.plaque3,"autre"===e.userVehiculeForm.type&&(e.userVehiculeForm.type=e.userVehiculeForm.autreType),a.addVehicule(e.userVehiculeForm),e.$parent.vehicules.push(e.userVehiculeForm),e.resetForm(),angular.element("#modalAddVehicule").modal("hide"),e.$parent.$parent.showSuccessMessage=!0,e.$parent.$parent.successMessage="Véhicule ajouté avec succès")},e.resetForm=function(){e.vehiculeForm.$setPristine(),angular.element("div.form-group").removeClass("has-success has-error"),e.userVehiculeForm={marque:"",plaque:"",chassis:"",modele:"",type:""}}}]).controller("EditVehiculeController",["$scope","VehiculesService",function(e,a){e.plaquePattern2=/^[a-zA-Z]{3}$/,e.plaquePattern3=/^[0-9]{3}$/,e.vehicule.numero_chassis1=(e.vehicule.numero_chassis+"*****").slice(0,5),e.vehicule.numero_chassis2=(e.vehicule.numero_chassis+"*****").slice(6,11),e.vehicule.numero_chassis3=(e.vehicule.numero_chassis+"*****").slice(12,17),e.vehicule.numero_chassis4=(e.vehicule.numero_chassis+"******").slice(18,24),e.updateVehicule=function(){var o={id:e.vehicule.id,marque:e.vehicule.marque,modele:e.vehicule.modele,plaque:e.vehicule.plaque1+"-"+e.vehicule.plaque2+"-"+e.vehicule.plaque3,numero_chassis:e.vehicule.numero_chassis1+"-"+e.vehicule.numero_chassis2+"-"+e.vehicule.numero_chassis3+"-"+e.vehicule.numero_chassis4,type:e.vehicule.type};a.updateVehicule(o),e.vehicule.plaque=e.vehicule.plaque1+"-"+e.vehicule.plaque2+"-"+e.vehicule.plaque3,e.vehicule.numero_chassis=e.vehicule.numero_chassis1+"-"+e.vehicule.numero_chassis2+"-"+e.vehicule.numero_chassis3+"-"+e.vehicule.numero_chassis4,angular.element("#modalEditVehicule"+e.vehicule.id).modal("hide"),e.$parent.$parent.$parent.showSuccessMessage=!0,e.$parent.$parent.$parent.successMessage="Véhicule "+e.vehicule.marque+" "+e.vehicule.modele+" mis à jour avec succès"},e.backupVehicule={id:e.vehicule.id,marque:e.vehicule.marque,modele:e.vehicule.modele,plaque:e.vehicule.plaque,numero_chassis:e.vehicule.numero_chassis1+"-"+e.vehicule.numero_chassis2+"-"+e.vehicule.numero_chassis3+"-"+e.vehicule.numero_chassis4,type:e.vehicule.type},e.cancelEdit=function(){console.log("edit annulé"),console.log("vehicule de backup",e.backupVehicule),console.log("vehicule modifié",e.vehicule),e.vehicule.marque=e.backupVehicule.marque,e.vehicule.modele=e.backupVehicule.modele,e.vehicule.plaque=e.backupVehicule.plaque,e.vehicule.numero_chassis=e.backupVehicule.numero_chassis,e.vehicule.type=e.backupVehicule.type}}]).controller("ReparationsController",["$scope","ReparationsService",function(e,a){e.newReparation={intervention:"",description:"",date:"",vehicule_FK:""},e.addReparation=function(){var o=new Date(e.newReparation.date).toISOString(),i=o.slice(0,4),r=o.slice(5,7),n=parseInt(o.slice(8,10))+1,n=("0"+n).slice(-2),t=i+"-"+r+"-"+n;e.newReparation.vehicule_FK=e.vehicule.id,e.newReparation.date=t,a.addReparation(e.newReparation),e.vehicule.reparations||(e.vehicule.reparations=[]),e.vehicule.reparations.push(e.newReparation),angular.element("#modalAddReparation"+e.vehicule.id).modal("hide"),e.resetForm(),e.$parent.$parent.$parent.showSuccessMessage=!0,e.$parent.$parent.$parent.successMessage="Réparation ajoutée avec succès !"},e.resetForm=function(){var a="addReparationForm"+e.vehicule.id;angular.element("#"+a+" div.form-group").removeClass("has-success has-error"),e.newReparation={intervention:"",description:"",date:"",vehicule_FK:""},e[a].$setPristine(),console.log("Formulaire #"+a+" remis à zéro")}}]).controller("EditReparationController",["$scope","ReparationsService",function(e,a){e.datePattern=/^[0-9]{4}-[0-9]{2}\-[0-9]{2}$/,e.backup={id:0,intervention:"",description:"",date:""},e.backup.id=e.reparation.id,e.backup.intervention=e.reparation.intervention,e.backup.description=e.reparation.description,e.backup.date=e.reparation.date,e.backup.vehicule_FK=e.reparation.vehicule_FK,e.cancelEdit=function(){e.editMode=!1,e.reparation.id=e.backup.id,e.reparation.intervention=e.backup.intervention,e.reparation.description=e.backup.description,e.reparation.date=e.backup.date,e.reparation.vehicule_FK=e.backup.vehicule_FK},e.updateReparation=function(){e.reparation.mode="angular",a.update(e.reparation).then(function(){e.editMode=!1,e.showUpdateMessage=!0},function(a){e.error=a.statusText,e.showErrorMessage=!0})},e.removeReparation=function(){var o=e.vehicule.reparations.indexOf(e.reparation),i=e.vehicules.indexOf(e.vehicule);console.log(o),console.log(i),confirm("Etes-vous sûr de vouloir supprimer cette réparation ?")&&a.delete(e.reparation.id).then(function(){angular.element("#modalShowReparation30").modal("hide"),angular.element("body").removeClass("modal-open"),angular.element(".modal-backdrop").remove(),e.$emit("reparationDeleted",[o,i,e.reparation.id]),console.log("réparation supprimée"),e.showDeleteMessage=!0},function(a){e.error=a.statusText,e.showError=!0,console.log(a)})},e.cleanAlerts=function(){e.showSuccessMessage=!1,e.showErrorMessage=!1}}]).controller("SVNavController",["$scope","VehiculesService",function(e,a){e.searchTerm="",e.hideSearchResult=!1,e.vehicules=a.getVehicules().then(function(a){e.vehicules=a}),e.setSearchTerm=function(a,o){e.searchTerm=o.plaque,e.hideSearchResult=!0}}]),function(e){"function"==typeof define&&define.amd?define(["../widgets/datepicker"],e):e(jQuery.datepicker)}(function(e){return e.regional.fr={closeText:"Fermer",prevText:"Précédent",nextText:"Suivant",currentText:"Aujourd'hui",monthNames:["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"],monthNamesShort:["Janv.","Févr.","Mars","Avr.","Mai","Juin","Juil.","Août","Sept.","Oct.","Nov.","Déc."],dayNames:["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"],dayNamesShort:["Dim.","Lun.","Mar.","Mer.","Jeu.","Ven.","Sam."],dayNamesMin:["D","L","M","M","J","V","S"],weekHeader:"Sem.",dateFormat:"yy-mm-dd",firstDay:1,isRTL:!1,showMonthAfterYear:!1,yearSuffix:""},e.setDefaults(e.regional.fr),e.regional.fr}),angular.module("garage").service("VehiculesService",["$http",function(e){this.getVehicules=function(){return e.get("index.php?p=vehicules.getVehicules").then(function(e){return console.log(e.data),e.data},function(e){return console.log(e),e})},this.addVehicule=function(a){e({method:"POST",url:"index.php?p=vehicules.addVehicule",data:$.param({marque:a.marque,plaque:a.plaque,type:a.type,numero_chassis1:a.numero_chassis1,numero_chassis2:a.numero_chassis2,numero_chassis3:a.numero_chassis3,numero_chassis4:a.numero_chassis4,numero_chassis5:a.numero_chassis5,plaque1:a.plaque1,plaque2:a.plaque2,plaque3:a.plaque3,modele:a.modele,autreType:a.autreType,mode:"angular"}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(e){console.log("succes VehiculesService.addVehicule | Réponse :"),console.log(e),a.id=e.data},function(e){console.log("erreur VehiculesService.addVehicule"),console.log(e),a.id=0})},this.updateVehicule=function(a){console.log(a),e({method:"POST",url:"index.php?p=vehicules.updateVehicule",data:$.param({marque:a.marque,plaque:a.plaque,type:a.type,numero_chassis:a.numero_chassis,modele:a.modele,id:a.id}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(e){console.log("succes VehiculesService.updateVehicule | Réponse :"),console.log(e)},function(e){console.log("erreur VehiculesService.updateVehicule"),console.log(e),a.id=0})},this.deleteVehicule=function(a){e({method:"POST",url:"index.php?p=vehicules.deleteVehicule",data:$.param({id:a}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(e){console.log("succes VehiculesService.deleteVehicule | Réponse :"),console.log(e)},function(e){console.log("erreur VehiculesService.deleteVehicule"),console.log(e)})},this.getOptions=function(){return e({method:"GET",url:"index.php?p=vehicules.getTypeOptions"}).then(function(e){return console.log(e),e.data})}}]).service("ReparationsService",["$http",function(e){this.addReparation=function(a){e({method:"POST",url:"index.php?p=reparations.addReparation",data:$.param({vehicule_FK:a.vehicule_FK,intervention:a.intervention,description:a.description,date:a.date}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(e){console.log("succes ReparationsService.addReparation | Réponse :"),console.log(e),a.id=e.data},function(e){console.log("erreur ReparationsService.addReparation"),console.log(e),a.id=0})},this.update=function(a){return e({method:"POST",url:"index.php?p=reparations.update",data:$.param({intervention:a.intervention,description:a.description,date:a.date,id:a.id,vehicule_FK:a.vehicule_FK,mode:a.mode}),headers:{"Content-Type":"application/x-www-form-urlencoded"}})},this.delete=function(a){return e({method:"GET",url:"index.php?p=reparations.delete&id="+a,headers:{"Content-Type":"application/x-www-form-urlencoded"}})}}]).service("LoadingInterceptor",["$q","$rootScope","$log",function(e,a,o){function i(){return t<n}function r(){a.loading=i()}var n=0,t=0;return{request:function(e){return n++,r(),e},requestError:function(a){return t++,r(),o.error("Request error:",a),e.reject(a)},response:function(e){return t++,r(),e},responseError:function(a){return t++,r(),o.error("Response error:",a),e.reject(a)}}}]);